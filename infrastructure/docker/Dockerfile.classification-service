# Classification Service - CXD Cognitive Classification
FROM memmimic-base:latest

LABEL service="classification-service" \
      description="MemMimic CXD cognitive classification service" \
      version="1.0.0"

# Set service-specific environment variables
ENV SERVICE_NAME=classification-service \
    SERVICE_PORT=8002 \
    EMBEDDING_MODEL_PATH=/app/models \
    ENABLE_GPU=false

# Install ML dependencies
RUN pip install --no-cache-dir \
    torch \
    transformers \
    faiss-cpu \
    scikit-learn

# Create models directory
RUN mkdir -p /app/models && chown memmimic:memmimic /app/models

# Copy service-specific configuration
COPY infrastructure/config/classification-service.yaml ./config/

# Copy classification service components
COPY src/memmimic/cxd/ ./src/memmimic/cxd/
COPY src/memmimic/errors/ ./src/memmimic/errors/
COPY src/memmimic/security/ ./src/memmimic/security/

# Pre-download models (runs as root then changes ownership)
USER root
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2', cache_folder='/app/models')"
RUN chown -R memmimic:memmimic /app/models
USER memmimic

# Expose service port
EXPOSE 8002

# Health check
HEALTHCHECK --interval=30s --timeout=15s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8002/health || exit 1

# Start classification service
CMD ["gunicorn", "--bind", "0.0.0.0:8002", "--workers", "2", "--worker-class", "uvicorn.workers.UvicornWorker", "--timeout", "60", "memmimic.services.classification:app"]